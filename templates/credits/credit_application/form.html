{% extends "layouts/dashboard.html" %}
{% load static %}
{% load i18n %}
{% load widget_tweaks %}

{% block title_page %}
    {% if object %}
        {% trans "Edit Credit Application" %}
    {% else %}
        {% trans "New Credit Application" %}
    {% endif %}
{% endblock title_page %}

{% block toolbar_title %}
    {% if object %}
        {% trans "Edit Credit Application" %}
    {% else %}
        {% trans "New Credit Application" %}
    {% endif %}
{% endblock %}

{% block entity_options %}
<div class="d-flex align-items-center py-1">
    <a href="{% url 'apps.credits:credit_application_list' %}" class="btn btn-sm btn-light">
        <i class="ki-duotone ki-arrow-left fs-4">
            <span class="path1"></span>
            <span class="path2"></span>
        </i>
        {% trans "Back" %}
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-xxl">
    <form method="post" class="form">
        {% csrf_token %}

        <!-- Main Application Form -->
        <div class="row g-5 g-xl-8">
            <!-- Left Column: Partner & Product Selection -->
            <div class="col-xl-6">
                <div class="card card-flush h-md-100">
                    <div class="card-header">
                        <div class="card-title">
                            <h2 class="mb-0">{% trans "Application Information" %}</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Partner Selection -->
                        <div class="mb-7">
                            <label class="form-label required fw-semibold fs-6 mb-2">{{ form.partner.label }}</label>
                            {{ form.partner|add_class:"form-select form-select-solid" }}
                            {% if form.partner.errors %}
                                <div class="text-danger fs-7 mt-1">{{ form.partner.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text text-muted">{% trans "Select the partner applying for credit" %}</div>
                        </div>

                        <!-- Management Fields -->
                        {% if form.assigned_to and form.assigned_to.field.widget.input_type != 'hidden' %}
                            <div class="mb-7">
                                <label class="form-label fw-semibold fs-6 mb-2">{{ form.assigned_to.label }}</label>
                                {{ form.assigned_to|add_class:"form-select form-select-solid" }}
                                {% if form.assigned_to.errors %}
                                    <div class="text-danger fs-7 mt-1">{{ form.assigned_to.errors.0 }}</div>
                                {% endif %}
                                <div class="form-text text-muted">{% trans "Assign a staff member to handle this application" %}</div>
                            </div>
                            {% else %}
                            {{ form.assigned_to }}
                        {% endif %}

                        <!-- Product Selection -->
                        <div class="mb-7">
                            <label class="form-label required fw-semibold fs-6 mb-2">{{ form.product.label }}</label>
                            {{ form.product|add_class:"form-select form-select-solid" }}
                            {% if form.product.errors %}
                                <div class="text-danger fs-7 mt-1">{{ form.product.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text text-muted">{% trans "Choose the credit product type" %}</div>
                        </div>

                        <!-- Product Summary Section -->
                        <div id="product-summary" class="mb-7" style="display: none;">
                            <div class="notice d-flex bg-light-info rounded border-info border border-dashed p-6">
                                <i class="ki-duotone ki-information fs-2tx text-info me-4">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                <div class="d-flex flex-stack flex-grow-1">
                                    <div class="fw-semibold">
                                        <h4 class="text-gray-900 fw-bold">{% trans "Product Details" %}</h4>
                                        <div id="product-details" class="fs-6 text-gray-700">
                                            <div class="row g-3 mt-2">
                                                <div class="col-md-6">
                                                    <div class="d-flex flex-column">
                                                        <span class="fw-bold text-gray-800">{% trans "Type" %}:</span>
                                                        <span id="product-type-name" class="text-gray-600">-</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex flex-column">
                                                        <span class="fw-bold text-gray-800">{% trans "Payment Frequency" %}:</span>
                                                        <span id="payment-frequency" class="text-gray-600">-</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex flex-column">
                                                        <span class="fw-bold text-gray-800">{% trans "Amount Range" %}:</span>
                                                        <span id="amount-range" class="text-gray-600">-</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex flex-column">
                                                        <span class="fw-bold text-gray-800">{% trans "Interest Rate Range" %}:</span>
                                                        <span id="interest-rate-range" class="text-gray-600">-</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex flex-column">
                                                        <span class="fw-bold text-gray-800">{% trans "Term Range" %}:</span>
                                                        <span id="term-range" class="text-gray-600">-</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="d-flex flex-column">
                                                        <span class="fw-bold text-gray-800">{% trans "Interest Type" %}:</span>
                                                        <span id="interest-type" class="text-gray-600">-</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-12">
                                                    <div class="d-flex flex-column">
                                                        <span class="fw-bold text-gray-800">{% trans "Delinquency Rate Range" %}:</span>
                                                        <span id="delinquency-rate-range" class="text-gray-600">-</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="product-description" class="mt-4" style="display: none;">
                                                <div class="separator my-3"></div>
                                                <div class="d-flex flex-column">
                                                    <span class="fw-bold text-gray-800">{% trans "Description" %}:</span>
                                                    <span id="product-desc-text" class="text-gray-600 mt-1">-</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <!-- Status is handled by the change status view, not in the form -->
                        {% if not object %}
                            <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed p-6 mb-7">
                                <i class="ki-duotone ki-information-5 fs-2tx text-primary me-4">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                </i>
                                <div class="d-flex flex-stack flex-grow-1">
                                    <div class="fw-semibold">
                                        <div class="fs-6 text-gray-700">
                                            {% trans "New applications start in DRAFT status. Use the 'Change Status' action to modify the application status after creation." %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column: Request Details -->
            <div class="col-xl-6">
                <div class="card card-flush h-md-100">
                    <div class="card-header">
                        <div class="card-title">
                            <h2 class="mb-0">{% trans "Request Information" %}</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Financial Information -->
                        <div class="mb-7">
                            <label class="form-label required fw-semibold fs-6 mb-2">{{ form.requested_amount.label }}</label>
                            <div class="input-group input-group-solid">
                                <span class="input-group-text">$</span>
                                {{ form.requested_amount|add_class:"form-control form-control-solid" }}
                            </div>
                            {% if form.requested_amount.errors %}
                                <div class="text-danger fs-7 mt-1">{{ form.requested_amount.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text text-muted">{% trans "Enter the amount requested by the partner" %}</div>
                        </div>

                        <div class="row g-5 mb-7">
                            <div class="col-md-6">
                                <label class="form-label required fw-semibold fs-6 mb-2">{{ form.proposed_interest_rate.label }}</label>
                                <div class="input-group input-group-solid">
                                    {{ form.proposed_interest_rate|add_class:"form-control form-control-solid" }}
                                    <span class="input-group-text">%</span>
                                </div>
                                {% if form.proposed_interest_rate.errors %}
                                    <div class="text-danger fs-7 mt-1">{{ form.proposed_interest_rate.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label required fw-semibold fs-6 mb-2">{{ form.requested_term_duration.label }}</label>
                                <div class="input-group input-group-solid">
                                    {{ form.requested_term_duration|add_class:"form-control form-control-solid" }}
                                </div>
                                {% if form.requested_term_duration.errors %}
                                    <div class="text-danger fs-7 mt-1">{{ form.requested_term_duration.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row g-5 mb-7">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold fs-6 mb-2">{{ form.possible_start_date.label }}</label>
                                {{ form.possible_start_date|add_class:"form-control form-control-solid" }}
                                {% if form.possible_start_date.errors %}
                                    <div class="text-danger fs-7 mt-1">{{ form.possible_start_date.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold fs-6 mb-2">{{ form.proposed_delinquency_rate.label }}</label>
                                <div class="input-group input-group-solid">
                                    {{ form.proposed_delinquency_rate|add_class:"form-control form-control-solid" }}
                                    <span class="input-group-text">%</span>
                                </div>
                                {% if form.proposed_delinquency_rate.errors %}
                                    <div class="text-danger fs-7 mt-1">{{ form.proposed_delinquency_rate.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        {% if form.requested_payment_frequency %}
                        <div class="mb-7">
                            <label class="form-label fw-semibold fs-6 mb-2">{{ form.requested_payment_frequency.label }}</label>
                            {{ form.requested_payment_frequency|add_class:"form-select form-select-solid" }}
                            {% if form.requested_payment_frequency.errors %}
                                <div class="text-danger fs-7 mt-1">{{ form.requested_payment_frequency.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text text-muted">{% trans "How often payments will be made" %}</div>
                        </div>
                        {% endif %}

                        <!-- Calculated Payment -->
                        <div class="mb-7">
                            <label class="form-label fw-semibold fs-6 mb-2">{{ form.estimated_payment_amount.label }}</label>
                            <div class="input-group input-group-solid">
                                <span class="input-group-text">$</span>
                                {{ form.estimated_payment_amount|add_class:"form-control form-control-solid bg-light" }}
                            </div>
                            {% if form.estimated_payment_amount.errors %}
                                <div class="text-danger fs-7 mt-1">{{ form.estimated_payment_amount.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text text-muted">{% trans "Automatically calculated based on the values above" %}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Management Information Section -->
        {% if object %}
        <div class="row g-5 g-xl-8 mt-5">
            <div class="col-xl-12">
                <div class="card card-flush mb-6 mb-xl-9">
                    <div class="card-header">
                        <div class="card-title">
                            <h2 class="mb-0">{% trans "Status Management" %}</h2>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Info about status management -->
                        <div class="notice d-flex bg-light-info rounded border-info border border-dashed p-6">
                            <i class="ki-duotone ki-information fs-2tx text-info me-4">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            <div class="d-flex flex-stack flex-grow-1">
                                <div class="fw-semibold">
                                    <div class="fs-6 text-gray-700">
                                        {% trans "Status changes, dates, rejection reasons and notes are managed through the 'Change Status' action and tracked in the status history." %}
                                        {% if perms.credits.review_creditapplication or perms.credits.approve_creditapplication %}
                                        <div class="mt-2">
                                            <a href="{% url 'apps.credits:credit_application_change_status' object.pk %}" class="btn btn-sm btn-light-info">
                                                <i class="ki-duotone ki-arrows-loop fs-5 me-1">
                                                    <span class="path1"></span>
                                                    <span class="path2"></span>
                                                </i>
                                                {% trans "Change Status" %}
                                            </a>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Action Buttons -->
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-end gap-3 mt-6">
                    <a href="{% url 'apps.credits:credit_application_list' %}" class="btn btn-light btn-lg">
                        <i class="ki-duotone ki-arrow-left fs-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        {% trans "Cancel" %}
                    </a>
                    <button type="submit" class="btn btn-primary btn-lg">
                        {% if object %}
                            <i class="ki-duotone ki-check fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            {% trans "Update Application" %}
                        {% else %}
                            <i class="ki-duotone ki-plus fs-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            {% trans "Create Application" %}
                        {% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Credit Application Form JS Loaded');
    const productSelect = document.getElementById('id_product');
    const productSummary = document.getElementById('product-summary');

    if (productSelect && productSummary) {

        function handleProductChange() {
            const productId = productSelect.value;
            console.log("Product changed to:", productId);

            if (productId) {
                // Show loading state
                showProductSummary();
                showLoadingState();

                // Fetch product data via API
                fetch(`{% url 'apps.credits:api_product_summary' 0 %}`.replace('0', productId), {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Product data received:", data);
                    updateProductSummary(data);
                })
                .catch(error => {
                    console.error('Error fetching product data:', error);
                    hideProductSummary();
                });
            } else {
                hideProductSummary();
            }
        }

        // Handle both regular change event and Select2 events
        productSelect.addEventListener('change', handleProductChange);

        // Handle Select2 specific events
        $(productSelect).on('select2:select', function(e) {
            console.log('Select2 select event triggered');
            setTimeout(handleProductChange, 100); // Small delay to ensure value is set
        });

        $(productSelect).on('select2:clear', function(e) {
            console.log('Select2 clear event triggered');
            hideProductSummary();
        });

        // If editing and product is already selected, load its summary
        setTimeout(function() {
            if (productSelect.value) {
                console.log('Initial product value found:', productSelect.value);
                handleProductChange();
            }
        }, 500); // Delay to ensure Select2 is fully initialized
    }

    // Monthly Payment Calculator
    const amountField = document.getElementById('id_requested_amount');
    const interestRateField = document.getElementById('id_proposed_interest_rate');
    const termField = document.getElementById('id_requested_term_duration');
    const monthlyPaymentField = document.getElementById('id_estimated_payment_amount');

    if (amountField && interestRateField && termField && monthlyPaymentField) {

        function calculateMonthlyPayment() {
            const amount = parseFloat(amountField.value) || 0;
            const annualRate = parseFloat(interestRateField.value) || 0;
            const termMonths = parseInt(termField.value) || 0;

            // Validate against product limits if available
            validateFieldLimits();

            if (amount > 0 && annualRate >= 0 && termMonths > 0) {
                let monthlyPayment;

                if (annualRate === 0) {
                    // If no interest, just divide amount by term
                    monthlyPayment = amount / termMonths;
                } else {
                    // Standard loan payment formula: PMT = P * r * (1+r)^n / ((1+r)^n - 1)
                    const monthlyRate = annualRate / 100 / 12; // Convert annual % to monthly decimal
                    const factor = Math.pow(1 + monthlyRate, termMonths);
                    monthlyPayment = amount * monthlyRate * factor / (factor - 1);
                }

                // Round to 2 decimal places
                monthlyPayment = Math.round(monthlyPayment * 100) / 100;

                // Update the field
                monthlyPaymentField.value = monthlyPayment.toFixed(2);

                console.log(`Calculated monthly payment: $${monthlyPayment.toFixed(2)}`);
            } else {
                // Clear the field if inputs are invalid
                monthlyPaymentField.value = '';
            }
        }

        function validateFieldLimits() {
            if (!window.productLimits) return;

            // Validate amount
            const amount = parseFloat(amountField.value) || 0;
            if (amount > 0) {
                if (amount < window.productLimits.amount.min || amount > window.productLimits.amount.max) {
                    amountField.classList.add('is-invalid');
                    showFieldError(amountField, `{% trans "Amount must be between" %} $${window.productLimits.amount.min.toLocaleString()} - $${window.productLimits.amount.max.toLocaleString()}`);
                } else {
                    amountField.classList.remove('is-invalid');
                    hideFieldError(amountField);
                }
            }

            // Validate interest rate
            const rate = parseFloat(interestRateField.value) || 0;
            if (rate >= 0) {
                if (rate < window.productLimits.interestRate.min || rate > window.productLimits.interestRate.max) {
                    interestRateField.classList.add('is-invalid');
                    showFieldError(interestRateField, `{% trans "Interest rate must be between" %} ${window.productLimits.interestRate.min}% - ${window.productLimits.interestRate.max}%`);
                } else {
                    interestRateField.classList.remove('is-invalid');
                    hideFieldError(interestRateField);
                }
            }

            // Validate term
            const term = parseInt(termField.value) || 0;
            if (term > 0) {
                if (term < window.productLimits.term.min || term > window.productLimits.term.max) {
                    termField.classList.add('is-invalid');
                    showFieldError(termField, `{% trans "Term must be between" %} ${window.productLimits.term.min} - ${window.productLimits.term.max} {% trans "months" %}`);
                } else {
                    termField.classList.remove('is-invalid');
                    hideFieldError(termField);
                }
            }

            // Validate delinquency rate
            const delinquencyRateField = document.getElementById('id_proposed_delinquency_rate');
            if (delinquencyRateField && window.productLimits.delinquencyRate) {
                const delinquencyRate = parseFloat(delinquencyRateField.value) || 0;
                if (delinquencyRate >= 0) {
                    if (delinquencyRate < window.productLimits.delinquencyRate.min || delinquencyRate > window.productLimits.delinquencyRate.max) {
                        delinquencyRateField.classList.add('is-invalid');
                        showFieldError(delinquencyRateField, `{% trans "Delinquency rate must be between" %} ${window.productLimits.delinquencyRate.min}% - ${window.productLimits.delinquencyRate.max}%`);
                    } else {
                        delinquencyRateField.classList.remove('is-invalid');
                        hideFieldError(delinquencyRateField);
                    }
                }
            }
        }

        function showFieldError(field, message) {
            let errorDiv = field.parentNode.querySelector('.field-error');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'field-error text-danger fs-7 mt-1';
                field.parentNode.appendChild(errorDiv);
            }
            errorDiv.textContent = message;
        }

        function hideFieldError(field) {
            const errorDiv = field.parentNode.querySelector('.field-error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        // Make function globally accessible
        window.calculateMonthlyPayment = calculateMonthlyPayment;

        // Add event listeners to trigger calculation
        amountField.addEventListener('input', calculateMonthlyPayment);
        amountField.addEventListener('change', calculateMonthlyPayment);

        interestRateField.addEventListener('input', calculateMonthlyPayment);
        interestRateField.addEventListener('change', calculateMonthlyPayment);

        termField.addEventListener('input', calculateMonthlyPayment);
        termField.addEventListener('change', calculateMonthlyPayment);

        // Add validation for delinquency rate field
        const delinquencyRateField = document.getElementById('id_proposed_delinquency_rate');
        if (delinquencyRateField) {
            delinquencyRateField.addEventListener('input', validateFieldLimits);
            delinquencyRateField.addEventListener('change', validateFieldLimits);
        }

        // Calculate on page load if values exist
        calculateMonthlyPayment();
    }

    function showProductSummary() {
        productSummary.style.display = 'block';
    }

    function hideProductSummary() {
        productSummary.style.display = 'none';
    }

    function showLoadingState() {
        document.getElementById('product-type-name').textContent = '{% trans "Loading..." %}';
        document.getElementById('amount-range').textContent = '{% trans "Loading..." %}';
        document.getElementById('interest-rate-range').textContent = '{% trans "Loading..." %}';
        document.getElementById('term-range').textContent = '{% trans "Loading..." %}';
        document.getElementById('payment-frequency').textContent = '{% trans "Loading..." %}';
        document.getElementById('interest-type').textContent = '{% trans "Loading..." %}';
        document.getElementById('delinquency-rate-range').textContent = '{% trans "Loading..." %}';
    }

    function updateProductSummary(data) {
        // Update product information
        document.getElementById('product-type-name').textContent = data.product_type.name;
        document.getElementById('amount-range').textContent = data.amount_range.formatted;
        document.getElementById('interest-rate-range').textContent = data.interest_rate_range.formatted;
        document.getElementById('term-range').textContent = data.term_range.formatted;
        document.getElementById('payment-frequency').textContent = data.payment_frequency.display;
        document.getElementById('interest-type').textContent = data.interest_type.display;
        document.getElementById('delinquency-rate-range').textContent = data.delinquency_rate_range.formatted;

        // Auto-set minimum delinquency rate for new applications
        const delinquencyRateField = document.getElementById('id_proposed_delinquency_rate');
        if (delinquencyRateField && (!delinquencyRateField.value || delinquencyRateField.value === '')) {
            delinquencyRateField.value = data.delinquency_rate_range.min.toFixed(2);
            console.log(`Auto-set delinquency rate to minimum: ${data.delinquency_rate_range.min}%`);
        }

        // Handle description
        const descriptionDiv = document.getElementById('product-description');
        const descriptionText = document.getElementById('product-desc-text');

        if (data.description && data.description.trim() !== '') {
            descriptionText.textContent = data.description;
            descriptionDiv.style.display = 'block';
        } else {
            descriptionDiv.style.display = 'none';
        }

        // Update form field constraints based on product limits
        updateFormConstraints(data);
    }

    function updateFormConstraints(data) {
        // Store product limits globally for validation
        window.productLimits = {
            amount: { min: data.amount_range.min, max: data.amount_range.max },
            interestRate: { min: data.interest_rate_range.min, max: data.interest_rate_range.max },
            term: { min: data.term_range.min, max: data.term_range.max },
            delinquencyRate: { min: data.delinquency_rate_range.min, max: data.delinquency_rate_range.max }
        };

        // Update amount field constraints
        const amountField = document.getElementById('id_requested_amount');
        if (amountField) {
            amountField.setAttribute('min', data.amount_range.min);
            amountField.setAttribute('max', data.amount_range.max);
            amountField.setAttribute('title',
                `{% trans "Amount must be between" %} ${data.amount_range.formatted}`);
        }

        // Update interest rate field constraints
        const interestField = document.getElementById('id_proposed_interest_rate');
        if (interestField) {
            interestField.setAttribute('min', data.interest_rate_range.min);
            interestField.setAttribute('max', data.interest_rate_range.max);
            interestField.setAttribute('title',
                `{% trans "Interest rate must be between" %} ${data.interest_rate_range.formatted}`);
        }

        // Update term field constraints
        const termField = document.getElementById('id_requested_term_duration');
        if (termField) {
            termField.setAttribute('min', data.term_range.min);
            termField.setAttribute('max', data.term_range.max);
            termField.setAttribute('title',
                `{% trans "Term must be between" %} ${data.term_range.formatted}`);
        }

        // Update delinquency rate field constraints
        const delinquencyField = document.getElementById('id_proposed_delinquency_rate');
        if (delinquencyField) {
            delinquencyField.setAttribute('min', data.delinquency_rate_range.min);
            delinquencyField.setAttribute('max', data.delinquency_rate_range.max);
            delinquencyField.setAttribute('title',
                `{% trans "Delinquency rate must be between" %} ${data.delinquency_rate_range.formatted}`);
        }

        // Trigger calculation after updating constraints
        if (window.calculateMonthlyPayment) {
            window.calculateMonthlyPayment();
        }
    }
});
</script>
{% endblock %}
