{% extends "layouts/home.html" %}
{% load static %}
{% load i18n %}

{% block title_page %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'assets/css/payments.css' %}">
{% endblock %}

{% block content %}
<!-- Header con Logo -->
<div class="payment-header bg-white border-bottom shadow-sm py-4 mb-5">
    <div class="container-fluid">
        <div class="d-flex justify-content-center">
            <img src="{{ MEDIA_URL }}{{ config.COMPANY_LOGO_BLACK }}" alt="{{ config.PROJECT_NAME }}" class="payment-logo" />
        </div>
    </div>
</div>

<div class="payment-main-container">
    <div class="container-fluid">
        <div class="row g-5">
            <!-- Columna Izquierda: Deudas -->
            <div class="col-lg-7">
                <div class="card shadow-sm border-0">
                    <!--begin::Header-->
                    <div class="card-header bg-white border-0 pt-6 pb-0">
                        <div class="d-flex align-items-center mb-4">
                            <div class="symbol symbol-50px me-3">
                                <div class="symbol-label bg-light-primary text-primary fw-bold fs-3">
                                    {{ partner.initials }}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="mb-1 fw-bold text-gray-900">{{ partner.full_name }}</h5>
                                <p class="mb-0 text-gray-600 fs-7">
                                    <i class="ki-duotone ki-profile-user fs-6 me-1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                        <span class="path3"></span>
                                        <span class="path4"></span>
                                    </i>
                                    {{ partner.document_number }}
                                </p>
                            </div>
                            <span class="badge badge-light-primary fs-7 px-4 py-2">
                                <i class="ki-duotone ki-document fs-5 me-1">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                {{ debts|length }} {% trans "deudas" %}
                            </span>
                        </div>
                        <div class="separator mb-4"></div>
                    </div>
                    <!--end::Header-->

                    <!--begin::Body-->
                    <div class="card-body pt-0 pb-6">
                        <div class="d-flex justify-content-between align-items-center mb-6">
                            <h6 class="mb-0 fw-bold text-gray-800">{% trans "Deudas Disponibles" %}</h6>
                            <button type="button" class="btn btn-sm btn-light-primary" onclick="selectAll()">
                                <span id="select-all-text">
                                    <i class="ki-duotone ki-check fs-5 me-1">
                                        <span class="path1"></span>
                                        <span class="path2"></span>
                                    </i>
                                    {% trans "Seleccionar todas" %}
                                </span>
                            </button>
                        </div>

                        <form id="payment-form" method="post">
                            {% csrf_token %}

                            <div class="debt-list">
                                {% for debt in debts %}
                                <div class="debt-item-card mb-3 p-4 border border-gray-300 rounded-3 bg-hover-light-primary cursor-pointer"
                                     data-amount="{{ debt.amount }}"
                                     data-debt-id="{{ debt.object.id }}"
                                     data-debt-type="{{ debt.type }}"
                                     onclick="toggleDebt(this, event)">
                                    <div class="d-flex align-items-start">
                                        <div class="form-check form-check-custom form-check-solid me-4 mt-1">
                                            <input class="form-check-input debt-checkbox"
                                                   type="checkbox"
                                                   name="selected_debts"
                                                   value="{{ debt.object.id }}"
                                                   data-type="{{ debt.type }}"
                                                   data-amount="{{ debt.amount }}"
                                                   checked
                                                   id="debt_{{ forloop.counter }}">

                                        </div>

                                        <div class="flex-grow-1">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div>
                                                    <span class="badge badge-light-{% if debt.type == 'Aporte' %}primary{% elif debt.type == 'Aportación' %}success{% elif debt.type == 'Seguridad Social' %}info{% elif debt.type == 'Penalidad' %}danger{% endif %} fs-8 fw-semibold mb-1">
                                                        {{ debt.type }}
                                                    </span>
                                                    <h6 class="mb-1 fw-bold text-gray-900 fs-6">{{ debt.description }}</h6>
                                                    <p class="mb-0 text-gray-600 fs-7">
                                                        <i class="ki-duotone ki-calendar fs-6 me-1 text-gray-500">
                                                            <span class="path1"></span>
                                                            <span class="path2"></span>
                                                        </i>
                                                        {% trans "Vence:" %} {{ debt.due_date|date:"d/m/Y" }}
                                                        {% if debt.due_date < today %}
                                                        <span class="badge badge-light-danger ms-2">{% trans "Vencida" %}</span>
                                                        {% endif %}
                                                    </p>
                                                </div>
                                                <div class="text-end">
                                                    <h5 class="mb-0 fw-bolder text-gray-900">PEN {{ debt.amount|floatformat:2 }}</h5>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Hidden fields for Culqi -->
                            <input type="hidden" id="culqi_token" name="culqi_token">
                        </form>

                        {% if debts|length > 2 %}
                        <div class="alert alert-dismissible bg-light-info border border-info border-dashed d-flex flex-column flex-sm-row w-100 p-5 mt-5">
                            <i class="ki-duotone ki-information-5 fs-2hx text-info me-4 mb-5 mb-sm-0">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            <div class="d-flex flex-column pe-0 pe-sm-10">
                                <h6 class="fw-semibold mb-1">{% trans "Nota importante" %}</h6>
                                <span class="text-gray-700">{% trans "Las deudas vencidas se pagan primero. Puede seleccionar las deudas que desea pagar." %}</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    <!--end::Body-->
                </div>
            </div>

            <!-- Columna Derecha: Resumen de Pago -->
            <div class="col-lg-5">
                <div class="card shadow-sm border-0 sticky-top" style="top: 20px;">
                    <!--begin::Header-->
                    <div class="card-header bg-light border-0">
                        <h3 class="card-title fw-bold text-gray-900">
                            <i class="ki-duotone ki-calculator fs-2 text-primary me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                                <span class="path3"></span>
                            </i>
                            {% trans "Resumen de Pago" %}
                        </h3>
                    </div>
                    <!--end::Header-->

                    <!--begin::Body-->
                    <div class="card-body pt-0">
                        <div class="separator my-5"></div>

                        <!-- Subtotal -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <span class="text-gray-700 fs-5">{% trans "Subtotal" %}</span>
                            <span class="text-gray-900 fs-4 fw-semibold" id="subtotal">PEN {{ magic_link.amount|floatformat:2 }}</span>
                        </div>

                        <div class="separator separator-dashed my-5"></div>

                        <!-- Total -->
                        <div class="d-flex justify-content-between align-items-center mb-6">
                            <span class="text-gray-900 fs-3 fw-bold">{% trans "Total a Pagar" %}</span>
                            <span class="text-primary fs-2x fw-bolder" id="total">PEN {{ magic_link.amount|floatformat:2 }}</span>
                        </div>

                        <!-- Botón de Pago -->
                        <button type="button" class="btn btn-lg btn-primary w-100 mb-5" id="pay-button" onclick="processPayment()">
                            <i class="ki-duotone ki-credit-cart fs-2 me-2">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <span id="pay-button-text">{% trans "Pagar" %} <span id="pay-amount">PEN {{ magic_link.amount|floatformat:2 }}</span></span>
                        </button>

                        <div class="separator separator-content my-6">
                            <span class="text-gray-600 fs-7 fw-semibold">{% trans "Métodos de Pago" %}</span>
                        </div>

                        <!-- Payment Methods -->
                        <div class="d-flex flex-wrap gap-3 mb-6">
                            <div class="badge badge-light-primary p-3 d-flex align-items-center">
                                <i class="ki-duotone ki-credit-cart fs-2x text-primary me-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <span class="fs-7">{% trans "Tarjetas" %}</span>
                            </div>
                            <div class="badge badge-light-success p-3 d-flex align-items-center">
                                <i class="ki-duotone ki-wallet fs-2x text-success me-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                </i>
                                <span class="fs-7">{% trans "Yape" %}</span>
                            </div>
                            <div class="badge badge-light-info p-3 d-flex align-items-center">
                                <i class="ki-duotone ki-bank fs-2x text-info me-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                </i>
                                <span class="fs-7">{% trans "Banca" %}</span>
                            </div>
                            <div class="badge badge-light-warning p-3 d-flex align-items-center">
                                <i class="ki-duotone ki-shop fs-2x text-warning me-2">
                                    <span class="path1"></span>
                                    <span class="path2"></span>
                                    <span class="path3"></span>
                                    <span class="path4"></span>
                                    <span class="path5"></span>
                                </i>
                                <span class="fs-7">{% trans "Agentes" %}</span>
                            </div>
                        </div>

                        <!-- Notas de Seguridad -->
                        <div class="notice d-flex bg-light-primary rounded border-primary border border-dashed p-4">
                            <i class="ki-duotone ki-shield-tick fs-2tx text-primary me-4">
                                <span class="path1"></span>
                                <span class="path2"></span>
                            </i>
                            <div class="d-flex flex-stack flex-grow-1">
                                <div class="fw-semibold">
                                    <h6 class="text-gray-900 fw-bold mb-2">{% trans "Transacción Segura" %}</h6>
                                    <div class="fs-7 text-gray-700">
                                        {% trans "Tu pago está protegido con encriptación de nivel bancario. El proceso puede tomar hasta 48 horas." %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--end::Body-->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SweetAlert2 for better alerts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<!-- Culqi Checkout -->
<script src="https://checkout.culqi.com/js/v4"></script>
<script>
    // Configure Culqi
    const CULQI_PUBLIC_KEY = "{{ culqi_public_key|default:'pk_test_e8bdb4895b0548b4' }}";
    Culqi.publicKey = CULQI_PUBLIC_KEY;

    let selectedDebts = [];
    let allSelected = true;

    // Initialize selected debts
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.debt-checkbox');
        checkboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                const debtItem = checkbox.closest('.debt-item-card');
                debtItem.classList.add('border-primary', 'bg-light-primary');
                debtItem.classList.remove('border-gray-300');
                selectedDebts.push({
                    id: checkbox.value,
                    type: checkbox.dataset.type,
                    amount: parseFloat(checkbox.dataset.amount)
                });
            }

            // Agregar evento change al checkbox para sincronizar cuando se haga click directo
            checkbox.addEventListener('change', function(e) {
                e.stopPropagation();
                const debtItem = this.closest('.debt-item-card');
                const debtId = this.value;
                const debtType = this.dataset.type;
                const debtAmount = parseFloat(this.dataset.amount);

                if (this.checked) {
                    debtItem.classList.add('border-primary', 'bg-light-primary');
                    debtItem.classList.remove('border-gray-300');
                    // Evitar duplicados
                    if (!selectedDebts.find(d => d.id === debtId)) {
                        selectedDebts.push({
                            id: debtId,
                            type: debtType,
                            amount: debtAmount
                        });
                    }
                } else {
                    debtItem.classList.remove('border-primary', 'bg-light-primary');
                    debtItem.classList.add('border-gray-300');
                    selectedDebts = selectedDebts.filter(d => d.id !== debtId);
                }

                updateTotal();
                updateSelectAllButton();
            });
        });
        updateTotal();
    });

    function toggleDebt(element, event) {
        // Si el click fue directamente en el checkbox, no hacer nada (dejar que el checkbox maneje el evento)
        if (event && event.target.classList.contains('debt-checkbox')) {
            return;
        }

        const checkbox = element.querySelector('.debt-checkbox');
        checkbox.checked = !checkbox.checked;

        const debtId = checkbox.value;
        const debtType = checkbox.dataset.type;
        const debtAmount = parseFloat(checkbox.dataset.amount);

        if (checkbox.checked) {
            element.classList.add('border-primary', 'bg-light-primary');
            element.classList.remove('border-gray-300');
            selectedDebts.push({
                id: debtId,
                type: debtType,
                amount: debtAmount
            });
        } else {
            element.classList.remove('border-primary', 'bg-light-primary');
            element.classList.add('border-gray-300');
            selectedDebts = selectedDebts.filter(d => d.id !== debtId);
        }

        updateTotal();
        updateSelectAllButton();
    }

    function selectAll() {
        const checkboxes = document.querySelectorAll('.debt-checkbox');
        const debtItems = document.querySelectorAll('.debt-item-card');

        allSelected = !allSelected;
        selectedDebts = [];

        checkboxes.forEach(function(checkbox, index) {
            checkbox.checked = allSelected;
            if (allSelected) {
                debtItems[index].classList.add('border-primary', 'bg-light-primary');
                debtItems[index].classList.remove('border-gray-300');
                selectedDebts.push({
                    id: checkbox.value,
                    type: checkbox.dataset.type,
                    amount: parseFloat(checkbox.dataset.amount)
                });
            } else {
                debtItems[index].classList.remove('border-primary', 'bg-light-primary');
                debtItems[index].classList.add('border-gray-300');
            }
        });

        updateTotal();
        updateSelectAllButton();
    }

    function updateSelectAllButton() {
        const checkboxes = document.querySelectorAll('.debt-checkbox');
        const checkedCount = document.querySelectorAll('.debt-checkbox:checked').length;
        const selectAllText = document.getElementById('select-all-text');
        const payButton = document.getElementById('pay-button');

        if (checkedCount === checkboxes.length && checkedCount > 0) {
            allSelected = true;
            selectAllText.innerHTML = '<i class="ki-duotone ki-cross fs-5 me-1"><span class="path1"></span><span class="path2"></span></i>{% trans "Deseleccionar todas" %}';
        } else {
            allSelected = false;
            selectAllText.innerHTML = '<i class="ki-duotone ki-check fs-5 me-1"><span class="path1"></span><span class="path2"></span></i>{% trans "Seleccionar todas" %}';
        }

        // Enable/disable pay button
        payButton.disabled = checkedCount === 0;
    }

    function updateTotal() {
        const total = selectedDebts.reduce((sum, debt) => sum + debt.amount, 0);
        document.getElementById('subtotal').textContent = 'PEN ' + total.toFixed(2);
        document.getElementById('total').textContent = 'PEN ' + total.toFixed(2);
        document.getElementById('pay-amount').textContent = 'PEN ' + total.toFixed(2);

        updateSelectAllButton();
    }

    function processPayment() {
        const checkedDebts = selectedDebts;

        if (checkedDebts.length === 0) {
            Swal.fire({
                icon: 'warning',
                title: '{% trans "Selección requerida" %}',
                text: '{% trans "Por favor selecciona al menos una deuda para pagar" %}',
                confirmButtonColor: '#80C6AC'
            });
            return;
        }

        const total = checkedDebts.reduce((sum, debt) => sum + debt.amount, 0);

        // Configure Culqi Checkout
        Culqi.settings({
            title: '{% trans "Pago de Deudas" %} - {{ partner.full_name }}',
            currency: 'PEN',
            amount: Math.round(total * 100), // Convert to cents
            order: 'ord_live_{{ magic_link.token }}',
            description: `{% trans "Pago de" %} ${checkedDebts.length} {% trans "deuda(s) pendiente(s)" %}`,
            xculqirsaid: '{{ culqi_rsa_id|default:"" }}',
            rsapublickey: '{{ culqi_rsa_public_key|default:"" }}'
        });

        Culqi.options({
            lang: 'es',
            installments: false,
            paymentMethods: {
                tarjeta: true,
                yape: true,
                billetera: true,
                bancaMovil: true,
                agente: true,
                cuotealo: true
            },
            style: {
                logo: '',
                maincolor: '#80C6AC',
                buttontext: '#ffffff',
                maintext: '#0f172a',
                desctext: '#64748b'
            }
        });

        // Show loading state
        const payButton = document.getElementById('pay-button');
        const originalText = payButton.innerHTML;
        payButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>{% trans "Procesando..." %}';
        payButton.disabled = true;

        try {
            // Open Culqi Checkout
            Culqi.open();
        } catch (error) {
            console.error('Error opening Culqi:', error);
            Swal.fire({
                icon: 'error',
                title: '{% trans "Error de Pago" %}',
                text: '{% trans "No se pudo inicializar el sistema de pagos. Por favor, intente nuevamente." %}',
                confirmButtonColor: '#80C6AC'
            });

            // Restore button
            payButton.innerHTML = originalText;
            payButton.disabled = false;
        }
    }

    // Culqi callback when token is generated
    function culqi() {
        const payButton = document.getElementById('pay-button');

        if (Culqi.token) {
            const token = Culqi.token.id;

            // Set token in hidden field
            document.getElementById('culqi_token').value = token;

            // Add selected debts to form
            const form = document.getElementById('payment-form');

            // Remove existing hidden debt inputs
            const existingInputs = form.querySelectorAll('input[name^="selected_debt_"]');
            existingInputs.forEach(input => input.remove());

            // Add current selected debts
            selectedDebts.forEach((debt, index) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `selected_debt_${index}`;
                input.value = JSON.stringify(debt);
                form.appendChild(input);
            });

            // Show success message
            Swal.fire({
                icon: 'success',
                title: '{% trans "¡Pago Procesado!" %}',
                text: '{% trans "Su pago ha sido procesado exitosamente. Recibirá una confirmación por correo electrónico." %}',
                confirmButtonColor: '#80C6AC',
                allowOutsideClick: false,
                allowEscapeKey: false
            }).then(() => {
                // Submit form
                form.submit();
            });

        } else if (Culqi.error) {
            // Handle error
            console.error('Culqi Error:', Culqi.error);

            let errorMessage = '{% trans "Ocurrió un error durante el procesamiento del pago" %}';
            if (Culqi.error.user_message) {
                errorMessage = Culqi.error.user_message;
            }

            Swal.fire({
                icon: 'error',
                title: '{% trans "Error de Pago" %}',
                text: errorMessage,
                confirmButtonColor: '#80C6AC'
            });

            // Restore button
            const total = selectedDebts.reduce((sum, debt) => sum + debt.amount, 0);
            payButton.innerHTML = '<i class="ki-duotone ki-credit-cart fs-2 me-2"><span class="path1"></span><span class="path2"></span></i><span id="pay-button-text">{% trans "Pagar" %} <span id="pay-amount">PEN ' + total.toFixed(2) + '</span></span>';
            payButton.disabled = selectedDebts.length === 0;
        }
    }

</script>
{% endblock %}
