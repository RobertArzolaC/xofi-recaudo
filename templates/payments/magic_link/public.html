{% extends "layouts/home.html" %}
{% load static %}
{% load i18n %}

{% block title_page %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .main-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem 1rem;
    }

    .payment-card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        max-width: 900px;
        width: 100%;
        overflow: hidden;
    }

    .header-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem;
        text-align: center;
        color: white;
    }

    .logo {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        color: white;
    }

    .client-info {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1rem;
        backdrop-filter: blur(10px);
    }

    .client-avatar {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        color: #667eea;
        margin: 0 auto 1rem;
    }

    .badge-debts {
        background: #10b981;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .debt-item {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
    }

    .debt-item:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .debt-item.selected {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .debt-icon {
        width: 50px;
        height: 50px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .debt-icon.aporte {
        background: #dbeafe;
        color: #3b82f6;
    }

    .debt-icon.contribution {
        background: #dcfce7;
        color: #10b981;
    }

    .debt-icon.social {
        background: #e0e7ff;
        color: #6366f1;
    }

    .debt-icon.penalty {
        background: #fee2e2;
        color: #ef4444;
    }

    .debt-details {
        flex-grow: 1;
    }

    .debt-type {
        font-size: 0.75rem;
        text-transform: uppercase;
        font-weight: 700;
        letter-spacing: 0.5px;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .debt-description {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .debt-due-date {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .debt-amount {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        text-align: right;
        flex-shrink: 0;
        margin-left: 1rem;
    }

    .debt-checkbox {
        width: 24px;
        height: 24px;
        margin-right: 1rem;
        cursor: pointer;
        flex-shrink: 0;
        accent-color: #667eea;
    }

    .summary-section {
        background: #f8f9fa;
        padding: 2rem;
        border-top: 3px solid #e5e7eb;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 1rem;
    }

    .summary-row.total {
        font-size: 1.5rem;
        font-weight: 700;
        padding-top: 1rem;
        border-top: 2px solid #d1d5db;
        margin-top: 1rem;
    }

    .btn-pay {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        font-size: 1.125rem;
        font-weight: 600;
        border-radius: 12px;
        width: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-pay:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        color: white;
    }

    .info-note {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 8px;
        margin-top: 1rem;
        font-size: 0.875rem;
        color: #1e40af;
    }

    .secure-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #10b981;
        font-size: 0.875rem;
        margin-top: 1rem;
    }

    .select-all-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .select-all-btn:hover {
        background: #5568d3;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-container">
    <div class="payment-card">
        <!--begin::Header-->
        <div class="header-section">
            <div class="logo">üü¢ XOFI</div>

            <div class="client-info">
                <div class="client-avatar">{{ partner.initials }}</div>
                <h4 class="mb-1">{{ partner.full_name }}</h4>
                <p class="mb-2 opacity-75">{{ partner.document_number }}</p>
                <span class="badge-debts">{{ debts|length }} {% trans "deudas" %}</span>
            </div>

            <h5 class="mt-3 mb-0">{{ magic_link.name }}</h5>
        </div>
        <!--end::Header-->

        <!--begin::Debts List-->
        <div class="p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">{% trans "Deudas Disponibles" %}</h5>
                <button class="select-all-btn" onclick="selectAll()">
                    <span id="select-all-text">‚úì {% trans "Seleccionar todas" %}</span>
                </button>
            </div>

            <form id="payment-form" method="post">
                {% csrf_token %}

                {% for debt in debts %}
                <div class="debt-item" data-amount="{{ debt.amount }}" onclick="toggleDebt(this)">
                    <input type="checkbox" class="debt-checkbox" name="debt_{{ forloop.counter }}"
                           value="{{ debt.object.id }}" data-type="{{ debt.type }}" checked>

                    <div class="debt-icon {% if debt.type == 'Aporte' %}aporte{% elif debt.type == 'Aportaci√≥n' %}contribution{% elif debt.type == 'Seguridad Social' %}social{% elif debt.type == 'Penalidad' %}penalty{% endif %}">
                        {% if debt.type == "Aporte" %}
                        <i class="ki-duotone ki-wallet fs-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                            <span class="path4"></span>
                        </i>
                        {% elif debt.type == "Aportaci√≥n" %}
                        <i class="ki-duotone ki-handshake fs-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        {% elif debt.type == "Seguridad Social" %}
                        <i class="ki-duotone ki-shield-tick fs-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                        </i>
                        {% elif debt.type == "Penalidad" %}
                        <i class="ki-duotone ki-information-5 fs-2">
                            <span class="path1"></span>
                            <span class="path2"></span>
                            <span class="path3"></span>
                        </i>
                        {% endif %}
                    </div>

                    <div class="debt-details">
                        <div class="debt-type">{{ debt.type }}</div>
                        <div class="debt-description">{{ debt.description }}</div>
                        <div class="debt-due-date">
                            {% trans "Vence:" %} {{ debt.due_date|date:"d/m/Y" }}
                        </div>
                    </div>

                    <div class="debt-amount">
                        PEN {{ debt.amount|floatformat:2 }}
                    </div>
                </div>
                {% endfor %}

                {% if debts|length > 2 %}
                <div class="info-note">
                    <i class="ki-duotone ki-information-5 fs-2 me-2">
                        <span class="path1"></span>
                        <span class="path2"></span>
                        <span class="path3"></span>
                    </i>
                    <strong>{% trans "Nota importante:" %}</strong>
                    {% trans "Las deudas vencidas se pagan primero" %}
                </div>
                {% endif %}
            </form>
        </div>
        <!--end::Debts List-->

        <!--begin::Summary-->
        <div class="summary-section">
            <h5 class="mb-4">{% trans "Resumen de Pago" %}</h5>

            <div class="summary-row">
                <span>{% trans "Deuda" %}</span>
                <span id="subtotal">PEN {{ magic_link.amount|floatformat:2 }}</span>
            </div>

            <div class="summary-row total">
                <span>{% trans "Total a Pagar:" %}</span>
                <span id="total">PEN {{ magic_link.amount|floatformat:2 }}</span>
            </div>

            <button type="button" class="btn-pay mt-4" onclick="processPayment()">
                <i class="ki-duotone ki-credit-cart fs-2 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                {% trans "Pagar" %} <span id="pay-amount">PEN {{ magic_link.amount|floatformat:2 }}</span>
            </button>

            <div class="info-note">
                <i class="ki-duotone ki-information-5 fs-2 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                    <span class="path3"></span>
                </i>
                {% trans "El proceso de pago puede demorar hasta 48 horas o 2 d√≠as h√°biles en completarse" %}
            </div>

            <div class="secure-badge">
                <i class="ki-duotone ki-lock fs-2 me-2">
                    <span class="path1"></span>
                    <span class="path2"></span>
                </i>
                {% trans "Transacci√≥n segura y protegida" %}
            </div>
        </div>
        <!--end::Summary-->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let allDebts = {{ magic_link.amount|floatformat:2 }};
    let selectedDebts = [];
    let allSelected = true;

    // Initialize selected debts
    document.addEventListener('DOMContentLoaded', function() {
        const checkboxes = document.querySelectorAll('.debt-checkbox');
        checkboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                const debtItem = checkbox.closest('.debt-item');
                debtItem.classList.add('selected');
                selectedDebts.push(parseFloat(debtItem.dataset.amount));
            }
        });
        updateTotal();
    });

    function toggleDebt(element) {
        const checkbox = element.querySelector('.debt-checkbox');
        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
            element.classList.add('selected');
            selectedDebts.push(parseFloat(element.dataset.amount));
        } else {
            element.classList.remove('selected');
            const amount = parseFloat(element.dataset.amount);
            selectedDebts = selectedDebts.filter(d => d !== amount);
        }

        updateTotal();
        updateSelectAllButton();
    }

    function selectAll() {
        const checkboxes = document.querySelectorAll('.debt-checkbox');
        const debtItems = document.querySelectorAll('.debt-item');

        allSelected = !allSelected;
        selectedDebts = [];

        checkboxes.forEach(function(checkbox, index) {
            checkbox.checked = allSelected;
            if (allSelected) {
                debtItems[index].classList.add('selected');
                selectedDebts.push(parseFloat(debtItems[index].dataset.amount));
            } else {
                debtItems[index].classList.remove('selected');
            }
        });

        updateTotal();
        updateSelectAllButton();
    }

    function updateSelectAllButton() {
        const checkboxes = document.querySelectorAll('.debt-checkbox');
        const checkedCount = document.querySelectorAll('.debt-checkbox:checked').length;
        const selectAllText = document.getElementById('select-all-text');

        if (checkedCount === checkboxes.length) {
            allSelected = true;
            selectAllText.textContent = '‚úó {% trans "Deseleccionar todas" %}';
        } else {
            allSelected = false;
            selectAllText.textContent = '‚úì {% trans "Seleccionar todas" %}';
        }
    }

    function updateTotal() {
        const total = selectedDebts.reduce((sum, amount) => sum + amount, 0);
        document.getElementById('subtotal').textContent = 'PEN ' + total.toFixed(2);
        document.getElementById('total').textContent = 'PEN ' + total.toFixed(2);
        document.getElementById('pay-amount').textContent = 'PEN ' + total.toFixed(2);
    }

    function processPayment() {
        const checkedDebts = document.querySelectorAll('.debt-checkbox:checked');

        if (checkedDebts.length === 0) {
            toastr.warning('{% trans "Por favor selecciona al menos una deuda para pagar" %}');
            return;
        }

        const total = selectedDebts.reduce((sum, amount) => sum + amount, 0);

        // TODO: Integrate with payment gateway (Culqi, etc.)
        toastr.info('{% trans "Redirigiendo a la pasarela de pago..." %}');

        // Simulate payment processing
        setTimeout(function() {
            toastr.warning('{% trans "Funcionalidad de pago pr√≥ximamente" %}');
        }, 1000);
    }
</script>
{% endblock %}
